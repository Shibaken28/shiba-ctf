<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Interactive Challenge </title>
    <link rel="stylesheet" type="text/css" href="./style.css">
  </head>
  <body>
    <h1> AES ECB Mode Decryption Service </h1>
    <h3> for beginner's AES</h3>
    <h4>注意！これはweb分野の問題ではありません．問題を解くのに，このサイトのソースコードを見る必要はありません．</h4>
    <form>
      <label for="key">Key (hex):</label> <br>
      <input readonly value = "SECRET" type="text" id="key" name="key" required ><br>

      <!--
      <label for="iv">IV (hex):</label><br>
      <input readonly value = "NONE" type="text" id="iv" name="iv" required><br>
      -->

      <label for="plaintext">Ciphertext (hex):</label><br>
      <input type="text" id="plaintext" name="plaintext" required><br>
      <br>
      <button type="button" onclick="encrypt()">Decrypt</button>
    </form>

    <h2>Result (hex):</h2>
    <div id="ciphertext"></div>

    <h2>Error:</h2>
    <div id="error"></div>
  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script>

      function decryptECB(key, encrypted) {
        const decrypted = CryptoJS.AES.decrypt(
          { ciphertext: CryptoJS.enc.Hex.parse(encrypted) },
          CryptoJS.enc.Hex.parse(key),
          { mode: CryptoJS.mode.ECB }
        );
        
        // パディング処理
        var s = CryptoJS.enc.Hex.stringify(decrypted);
        while (s.length % 32 != 0){
          s = s + "0";
        }

        return s;
      }

      function encrypt() {
        var keyInput = document.getElementById("key");
        //var ivInput = document.getElementById("iv");
        var plaintextInput = document.getElementById("plaintext");
        var errorOutput = document.getElementById("error");
        var ciphertextOutput = document.getElementById("ciphertext");

        try {
          var keyHex = keyInput.value.trim();
          key = "c4ee6b811c4f16abfef7021dba412f62"
          //var iv = ivInput.value.trim();
          // Validate plaintext
          var txt = plaintextInput.value.trim();

          /*
          if(iv.length != 32){
            throw new Error("IV must be 16 bytes (32 hex characters)");
          }*/

          if(key.length != 32){
            throw new Error("Key must be 16 bytes (32 hex characters)");
          }
          if(txt.match(/[^0-9a-f]/i)){
            throw new Error("Plaintext must be hex only");
          }
          if(txt.length % 32 != 0){
            throw new Error("Plaintext must be a multiple of 16 bytes (32 hex characters)");
          }
          if(txt=="b6506e08641d53366fdbfa35e8549e24d7666bdf3cbad130ddeb8eb1d0c7b58a"){
            throw new Error("You can't decrypt this ciphertext which is the flag!");
          }

          const pt = decryptECB(key, txt);
          // 32の倍数でない場合は、先頭に0を追加する
          //while(decrypted.length % 32 != 0){
          //  decrypted = "0" + decrypted;
         // }
          if (pt == ""){
            throw new Error("Decryption failed");
          }

          errorOutput.innerText = "";
          ciphertextOutput.innerText  = pt
          // Encrypt
          // var ciphertext = CryptoJS.AES.decrypt(plaintext, key, { iv: iv, mode: CryptoJS.mode.CFB, padding: CryptoJS.pad.NoPadding });

          // Display result
          // errorOutput.innerText = "";
          // ciphertextOutput.innerText = ciphertext.ciphertext.toString(CryptoJS.enc.Hex);
          
        } catch (e) {
          // Display error message
          errorOutput.innerText = e.message;
          ciphertextOutput.innerText = "";
        }
      }
    </script>
  </body>
</html>
